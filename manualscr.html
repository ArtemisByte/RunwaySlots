<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Manual SCR System [BACK-UP]</title>
  <
    
  </style>
</head>
<body>
  <!-- NAVIGATION BAR -->
  <nav>
    <ul>
      <li><a href="index.html">Single Flight</a></li>
      <li><a href="multiflight.html">Multi Flight</a></li>
      <li><a href="scrchangerequest.html">SCR Change</a></li>
      <li><a href="historic-log.html">Historic Log</a></li>
      <li><a href="airport-search.html">Airport DB</a></li>
      <li><a href="gcrformat.html">GCR Format</a></li>
      <li><a href="quicklinks.html">Quick Links</a></li>
      <li><a href="https://forms.gle/nXCQzWxCcH5B1uZd6">Log Issues</a></li>
    </ul>
    <!-- Theme Toggle -->
    <div class="theme-switch">
      <label for="themeToggle">Dark Mode</label>
      <input type="checkbox" id="themeToggle" aria-label="Toggle Dark Mode">
    </div>
  </nav>

  <!-- MAIN CONTAINER -->
  <div class="container">
    <!-- Title Bar for the window -->
    <div class="title-bar">SCR Management System [BACK-UP]</div>
    <div class="window-content">
      <div class="btn-group">
        <!-- Buttons to add forms -->
        <button type="button" onclick="addNewSlotForm()">Add NEW Slot Form</button>
        <button type="button" onclick="addCancelSlotForm()">Add CANCEL Slot Form</button>
        <button type="button" onclick="addChangeScrForm()">Add CHANGE SCR Form</button>
        <!-- Show Log & Back to Top -->
        <button type="button" onclick="showLog()">Log</button>
        <button id="backToTop" type="button" onclick="scrollToTop()">Back to Top</button>
      </div>

      <!-- DIV to hold all dynamically added forms -->
      <div id="formsContainer"></div>

      <!-- LOG SECTION -->
      <div id="logContainer" class="log-section" style="display: none;">
        <h3>Message Log</h3>
        <table id="logTable">
          <thead>
            <tr>
              <th>Slot Action</th>
              <th>SCR Message</th>
            </tr>
          </thead>
          <tbody>
            <!-- Filled by code -->
          </tbody>
        </table>
        <button type="button" onclick="downloadCSV()">Download CSV</button>
      </div>
    </div>
  </div>

  <!-- TEMPLATES -->
  <!-- 1) NEW SLOT FORM -->
  <template id="newSlotTemplate">
    <div class="scr-form" data-slot-action="NEW">
      <button class="remove-btn" type="button" onclick="removeForm(this)">Remove Form</button>
      <h3>New Slot</h3>

      <div class="form-group">
        <label>Slot Type:</label>
        <select class="slotType">
          <option value="ARRIVAL">ARRIVAL</option>
          <option value="DEPARTURE">DEPARTURE</option>
        </select>
      </div>
      <div class="form-group">
        <label>Airport (3 Letters):</label>
        <input type="text" class="airportCode" maxlength="3" placeholder="e.g. VLC">
      </div>
      <div class="form-group">
        <label>Flight No.:</label>
        <input type="text" class="flightNumber" placeholder="e.g., FR6060">
      </div>
      <div class="form-group">
        <label>Date:</label>
        <input type="date" class="dateField">
      </div>
      <div class="form-group">
        <label>Seats:</label>
        <input type="number" class="numberOfSeats" placeholder="189" oninput="validateSeats(this)">
      </div>
      <div class="form-group">
        <label>Aircraft:</label>
        <input type="text" class="aircraftType" placeholder="73H">
      </div>
      <div class="form-group">
        <label>Time:</label>
        <input type="text" class="timeField" maxlength="4" placeholder="0725">
      </div>
      <div class="form-group">
        <label>Dest/Orig:</label>
        <input type="text" class="destinationOrigin" placeholder="MAD">
      </div>
      <div class="form-group">
        <label>Service:</label>
        <select class="serviceType">
          <option value="P">P</option>
          <option value="J">J</option>
          <option value="D">D</option>
          <option value="K">K</option>
          <option value="X">X</option>
        </select>
      </div>
      <!-- Buttons -->
      <div class="btn-group" style="justify-content: flex-start;">
        <button type="button" onclick="showSCR(this)">Show SCR</button>
        <button type="button" onclick="emailSCR(this)">Email SCR</button>
      </div>

      <div class="scrOutput"></div>
    </div>
  </template>

  <!-- 2) CANCEL SLOT FORM -->
  <template id="cancelSlotTemplate">
    <div class="scr-form" data-slot-action="CANCEL">
      <button class="remove-btn" type="button" onclick="removeForm(this)">Remove Form</button>
      <h3>Cancel Slot</h3>

      <div class="form-group">
        <label>Slot Type:</label>
        <select class="slotType">
          <option value="ARRIVAL">ARRIVAL</option>
          <option value="DEPARTURE">DEPARTURE</option>
        </select>
      </div>
      <div class="form-group">
        <label>Airport (3 Letters):</label>
        <input type="text" class="airportCode" maxlength="3" placeholder="e.g. VLC">
      </div>
      <div class="form-group">
        <label>Flight No.:</label>
        <input type="text" class="flightNumber" placeholder="e.g., FR6060">
      </div>
      <div class="form-group">
        <label>Date:</label>
        <input type="date" class="dateField">
      </div>
      <div class="form-group">
        <label>Seats:</label>
        <input type="number" class="numberOfSeats" placeholder="189" oninput="validateSeats(this)">
      </div>
      <div class="form-group">
        <label>Aircraft:</label>
        <input type="text" class="aircraftType" placeholder="73H">
      </div>
      <div class="form-group">
        <label>Time:</label>
        <input type="text" class="timeField" maxlength="4" placeholder="0725">
      </div>
      <div class="form-group">
        <label>Dest/Orig:</label>
        <input type="text" class="destinationOrigin" placeholder="MAD">
      </div>
      <div class="form-group">
        <label>Service:</label>
        <select class="serviceType">
          <option value="P">P</option>
          <option value="J">J</option>
          <option value="D">D</option>
          <option value="K">K</option>
          <option value="X">X</option>
        </select>
      </div>
      <!-- Buttons -->
      <div class="btn-group" style="justify-content: flex-start;">
        <button type="button" onclick="showSCR(this)">Show SCR</button>
        <button type="button" onclick="emailSCR(this)">Email SCR</button>
      </div>

      <div class="scrOutput"></div>
    </div>
  </template>

  <!-- 3) CHANGE SCR FORM -->
  <template id="changeScrTemplate">
    <div class="change-scr-container" data-slot-action="CHANGE">
      <button class="changeFormRemoveBtn" type="button" onclick="removeForm(this)">Remove Form</button>
      <h3>Change SCR</h3>
      
      <div class="requests-container">
        <h4>Old Request</h4>
        <div class="change-form-row old-request">
          <div class="change-form-group">
            <label>Slot</label>
            <select class="old_slotType">
              <option value="Arrival">Arrival</option>
              <option value="Departure">Departure</option>
            </select>
          </div>
          <div class="change-form-group">
            <label>Airport</label>
            <input type="text" class="old_airport" placeholder="DUB">
          </div>
          <div class="change-form-group">
            <label>Flight</label>
            <input type="text" class="old_flightNo" placeholder="FR123">
          </div>
          <div class="change-form-group">
            <label>Date</label>
            <input type="date" class="old_date">
          </div>
          <div class="change-form-group">
            <label>Seats</label>
            <input type="number" class="old_seats" placeholder="189" oninput="validateSeats(this)">
          </div>
          <div class="change-form-group">
            <label>A/C</label>
            <input type="text" class="old_acType" placeholder="73H">
          </div>
          <div class="change-form-group">
            <label>Time</label>
            <input type="text" class="old_time" placeholder="2100">
          </div>
          <div class="change-form-group">
            <label>D/O</label>
            <input type="text" class="old_do" placeholder="STN">
          </div>
          <div class="change-form-group">
            <label>STC</label>
            <select class="old_stc">
              <option value="P">P</option>
              <option value="D">D</option>
              <option value="T">T</option>
              <option value="K">K</option>
              <option value="J">J</option>
              <option value="X">X</option>
            </select>
          </div>
        </div>
      </div>

      <div class="requests-container">
        <h4>New Request</h4>
        <div class="change-form-row new-request">
          <div class="change-form-group">
            <label>Slot</label>
            <select class="new_slotType">
              <option value="Arrival">Arrival</option>
              <option value="Departure">Departure</option>
            </select>
          </div>
          <div class="change-form-group">
            <label>Airport</label>
            <input type="text" class="new_airport" placeholder="DUB">
          </div>
          <div class="change-form-group">
            <label>Flight</label>
            <input type="text" class="new_flightNo" placeholder="FR123">
          </div>
          <div class="change-form-group">
            <label>Date</label>
            <input type="date" class="new_date">
          </div>
          <div class="change-form-group">
            <label>Seats</label>
            <input type="number" class="new_seats" placeholder="189" oninput="validateSeats(this)">
          </div>
          <div class="change-form-group">
            <label>A/C</label>
            <input type="text" class="new_acType" placeholder="73H">
          </div>
          <div class="change-form-group">
            <label>Time</label>
            <input type="text" class="new_time" placeholder="2200">
          </div>
          <div class="change-form-group">
            <label>D/O</label>
            <input type="text" class="new_do" placeholder="STN">
          </div>
          <div class="change-form-group">
            <label>STC</label>
            <select class="new_stc">
              <option value="P">P</option>
              <option value="D">D</option>
              <option value="T">T</option>
              <option value="K">K</option>
              <option value="J">J</option>
              <option value="X">X</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Buttons -->
      <div class="btn-group" style="justify-content: flex-start;">
        <button type="button" onclick="showChangeSCR(this)">Show SCR</button>
        <button type="button" onclick="emailChangeSCR(this)">Email SCR</button>
      </div>

      <div class="change-scrOutput"></div>
    </div>
  </template>

  <footer> Created By: ArtemisByte </footer>
  
  <script>
    /******************************************
     THEME TOGGLE
    ******************************************/
    const themeToggle = document.getElementById('themeToggle');
    const body = document.body;
    const savedTheme = localStorage.getItem('theme') || 'light';
    applyTheme(savedTheme);

    function applyTheme(theme) {
      if (theme === 'dark') {
        body.classList.add('dark-mode');
        themeToggle.checked = true;
      } else {
        body.classList.remove('dark-mode');
        themeToggle.checked = false;
      }
    }

    themeToggle.addEventListener('change', () => {
      if (themeToggle.checked) {
        localStorage.setItem('theme', 'dark');
        applyTheme('dark');
      } else {
        localStorage.setItem('theme', 'light');
        applyTheme('light');
      }
    });

    /******************************************
     GLOBAL / LOG / EMAILS
    ******************************************/
    const formsContainer = document.getElementById('formsContainer');
    let logData = [];
    let airportEmails = {};

    // Automatically load your emails.json from /assets/
    async function loadEmailData() {
      try {
        const response = await fetch('assets/emails.json');
        if (!response.ok) {
          throw new Error(`Failed to load emails.json: status ${response.status}`);
        }
        airportEmails = await response.json();
        console.log("Loaded airport emails:", airportEmails);
      } catch (error) {
        console.error("Error fetching emails.json:", error);
        alert("Could not load airport emails from assets/emails.json. Email functionality may be limited.");
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      loadEmailData();
    });

    /******************************************
     BACK TO TOP SCROLL
    ******************************************/
    window.onscroll = function () {
      const backToTopButton = document.getElementById('backToTop');
      if (document.documentElement.scrollTop > 200 || document.body.scrollTop > 200) {
        backToTopButton.style.display = 'block';
      } else {
        backToTopButton.style.display = 'none';
      }
    };
    function scrollToTop() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    /******************************************
     ADD/REMOVE FORMS
    ******************************************/
    function addNewSlotForm() {
      const template = document.getElementById('newSlotTemplate');
      const clone = template.content.cloneNode(true);
      formsContainer.appendChild(clone);
    }
    function addCancelSlotForm() {
      const template = document.getElementById('cancelSlotTemplate');
      const clone = template.content.cloneNode(true);
      formsContainer.appendChild(clone);
    }
    function addChangeScrForm() {
      const template = document.getElementById('changeScrTemplate');
      const clone = template.content.cloneNode(true);
      formsContainer.appendChild(clone);
    }

    function removeForm(btn) {
      const parent = btn.closest('.scr-form') || btn.closest('.change-scr-container');
      if (parent) {
        parent.remove();
      }
    }

    /******************************************
     VALIDATE SEATS
    ******************************************/
    function validateSeats(input) {
      if (input.value.length > 3) {
        input.value = input.value.slice(0, 3);
      }
    }

    /******************************************
     DAY-OF-WEEK -> SCR CODE
    ******************************************/
    function getDayValue(dateObj) {
      const dayValues = {
        Sunday: '0000007',
        Monday: '1000000',
        Tuesday: '0200000',
        Wednesday: '0030000',
        Thursday: '0004000',
        Friday: '0000500',
        Saturday: '0000060'
      };
      const dayName = new Intl.DateTimeFormat('en-US', { weekday: 'long' }).format(dateObj);
      return dayValues[dayName] || '0000000';
    }
    function formatDateDDMMM(isoDate) {
      if (!isoDate) return '';
      const [yyyy, mm, dd] = isoDate.split('-');
      if (!yyyy || !mm || !dd) return '';
      const monthNames = ['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];
      const monthIndex = parseInt(mm,10) - 1;
      if (monthIndex < 0 || monthIndex > 11) return '';
      return dd + monthNames[monthIndex];
    }

    /******************************************
     1) SHOW SCR for NEW/CANCEL
    ******************************************/
    function showSCR(buttonEl) {
      const formDiv = buttonEl.closest('.scr-form');
      if (!formDiv) return;

      // data-slot-action -> 'NEW' or 'CANCEL'
      const action = formDiv.getAttribute('data-slot-action') || 'NEW';
      const slotType = formDiv.querySelector('.slotType').value;
      const airportCode = (formDiv.querySelector('.airportCode').value || '').toUpperCase();
      const flightNumber = (formDiv.querySelector('.flightNumber').value || '').trim();
      const dateVal = formDiv.querySelector('.dateField').value;
      const seatsVal = formDiv.querySelector('.numberOfSeats').value.padStart(3, '0');
      const acType = (formDiv.querySelector('.aircraftType').value || '').toUpperCase();
      const timeVal = formDiv.querySelector('.timeField').value.padStart(4, '0');
      const destOrig = (formDiv.querySelector('.destinationOrigin').value || '').toUpperCase();
      const serviceType = formDiv.querySelector('.serviceType').value;

      if (!airportCode || !flightNumber || !dateVal || !seatsVal || !acType || !timeVal || !destOrig) {
        alert('Please fill in all fields.');
        return;
      }
      const dateObj = new Date(dateVal);
      if (isNaN(dateObj.getTime())) {
        alert('Invalid date.');
        return;
      }

      const formattedDate = formatDateDDMMM(dateVal);
      const dayValue = getDayValue(dateObj);

      // Decide indicator
      let indicator = 'N'; // default for new
      let actionText = 'NEW SLOT';
      if (action === 'CANCEL') {
        indicator = 'D';
        actionText = 'CANCEL SLOT';
      }

      // Build the SCR lines
      let scrMessage = `SCR  
W24  
${formattedDate}  
${airportCode}  
`;
      if (slotType === 'ARRIVAL') {
        scrMessage += `${indicator}${flightNumber} ${formattedDate}${formattedDate} ${dayValue} 000${acType} ${destOrig}${timeVal} ${serviceType}  
SI ${actionText} REQ ${airportCode}`;
      } else {
        // DEPARTURE
        scrMessage += `${indicator} ${flightNumber} ${formattedDate}${formattedDate} ${dayValue} 000${acType} ${timeVal}${destOrig} ${serviceType}  
SI ${actionText} REQ ${airportCode}`;
      }

      // Show output
      const outEl = formDiv.querySelector('.scrOutput');
      outEl.textContent = scrMessage.trim();
      outEl.style.display = 'block';

      // Add to log
      logData.push({
        slotAction: actionText,
        scrMessage: scrMessage.trim()
      });
    }

    /******************************************
     2) EMAIL SCR for NEW/CANCEL
    ******************************************/
    function emailSCR(buttonEl) {
      const formDiv = buttonEl.closest('.scr-form');
      if (!formDiv) return;

      const outputEl = formDiv.querySelector('.scrOutput');
      const scrMsg = outputEl.textContent.trim();
      if (!scrMsg) {
        alert('No SCR message. Please click "Show SCR" first.');
        return;
      }

      // Airport code
      const airportCode = (formDiv.querySelector('.airportCode').value || '').toUpperCase();
      // Try to find airportEmail from the JSON
      const emailList = airportEmails[airportCode]?.email || 'slotdesk@ryanair.com';
      const ccEmail = 'slotdesk@ryanair.com';
      // subject from the heading
      const heading = formDiv.querySelector('h3')?.textContent.toUpperCase() || 'SLOT REQUEST';
      const subject = `${heading} REQ ${airportCode}`;

      const mailtoLink = `mailto:${emailList}?cc=${encodeURIComponent(ccEmail)}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(scrMsg)}`;
      window.location.href = mailtoLink;
    }

    /******************************************
     3) SHOW SCR for CHANGE (Old vs New)
    ******************************************/
    function showChangeSCR(buttonEl) {
      const container = buttonEl.closest('.change-scr-container');
      if (!container) return;

      // Gather old request
      const old_slotType = container.querySelector('.old_slotType').value;
      const old_airport  = (container.querySelector('.old_airport').value || '').toUpperCase();
      const old_flightNo = (container.querySelector('.old_flightNo').value || '').trim();
      const old_date     = container.querySelector('.old_date').value;
      const old_seats    = (container.querySelector('.old_seats').value || '').padStart(3,'0');
      const old_acType   = (container.querySelector('.old_acType').value || '').toUpperCase();
      const old_time     = (container.querySelector('.old_time').value || '').padStart(4,'0');
      const old_do       = (container.querySelector('.old_do').value || '').toUpperCase();
      const old_stc      = container.querySelector('.old_stc').value;

      // Gather new request
      const new_slotType = container.querySelector('.new_slotType').value;
      const new_airport  = (container.querySelector('.new_airport').value || '').toUpperCase();
      const new_flightNo = (container.querySelector('.new_flightNo').value || '').trim();
      const new_date     = container.querySelector('.new_date').value;
      const new_seats    = (container.querySelector('.new_seats').value || '').padStart(3,'0');
      const new_acType   = (container.querySelector('.new_acType').value || '').toUpperCase();
      const new_time     = (container.querySelector('.new_time').value || '').padStart(4,'0');
      const new_do       = (container.querySelector('.new_do').value || '').toUpperCase();
      const new_stc      = container.querySelector('.new_stc').value;

      // Validate
      if (!old_airport || !old_flightNo || !old_date || !old_acType || !old_time || !old_do ||
          !new_airport || !new_flightNo || !new_date || !new_acType || !new_time || !new_do) {
        alert('Please fill in all Old Request and New Request fields.');
        return;
      }

      // Build lines
      const old_ddmmm = formatDateDDMMM(old_date);
      const new_ddmmm = formatDateDDMMM(new_date);
      const old_dayVal = getDayValue(new Date(old_date));
      const new_dayVal = getDayValue(new Date(new_date));

      // We'll label them:
      //  C lines for old, R lines for new 
      const old_indicator = (old_slotType === 'Arrival') ? `C${old_flightNo}` : `C ${old_flightNo}`;
      const new_indicator = (new_slotType === 'Arrival') ? `R${new_flightNo}` : `R ${new_flightNo}`;

      let old_stationTime = '';
      if (old_slotType === 'Arrival') {
        old_stationTime = `${old_do}${old_time}`;
      } else {
        old_stationTime = `${old_time}${old_do}`;
      }

      let new_stationTime = '';
      if (new_slotType === 'Arrival') {
        new_stationTime = `${new_do}${new_time}`;
      } else {
        new_stationTime = `${new_time}${new_do}`;
      }

      // Example final message:
      let scrMessage = `SCR
W24
${old_ddmmm}
${old_airport}
${old_indicator} ${old_ddmmm}${old_ddmmm} ${old_dayVal} 000${old_acType} ${old_stationTime} ${old_stc}  
${new_indicator} ${new_ddmmm}${new_ddmmm} ${new_dayVal} 000${new_acType} ${new_stationTime} ${new_stc}

SI SLOT CHG REQ ${old_airport}`;

      // Show output
      const outEl = container.querySelector('.change-scrOutput');
      outEl.textContent = scrMessage.trim();
      outEl.style.display = 'block';

      // Add to log
      logData.push({
        slotAction: 'SCR CHANGE',
        scrMessage: scrMessage.trim()
      });
    }

    /******************************************
     4) EMAIL SCR for CHANGE
    ******************************************/
    function emailChangeSCR(buttonEl) {
      const container = buttonEl.closest('.change-scr-container');
      if (!container) return;
      const outEl = container.querySelector('.change-scrOutput');
      const scrMsg = outEl.textContent.trim();
      if (!scrMsg) {
        alert('No SCR message. Please click "Show SCR" first.');
        return;
      }

      // For "change," we guess the relevant airport from old_airport
      const old_airport = (container.querySelector('.old_airport').value || '').toUpperCase();
      const airportCode = old_airport || '???';

      const emailList = airportEmails[airportCode]?.email || 'slotdesk@ryanair.com';
      const ccEmail = 'slotdesk@ryanair.com';
      const subject = `CHANGE SCR REQ ${airportCode}`;

      const mailtoLink = `mailto:${emailList}?cc=${encodeURIComponent(ccEmail)}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(scrMsg)}`;
      window.location.href = mailtoLink;
    }

    /******************************************
     SHOW LOG
    ******************************************/
    function showLog() {
      const logContainer = document.getElementById('logContainer');
      const logTableBody = document.querySelector('#logTable tbody');
      logTableBody.innerHTML = '';

      if (logData.length === 0) {
        logContainer.style.display = 'none';
        alert('No log data available.');
        return;
      }

      logData.forEach(item => {
        const row = logTableBody.insertRow();
        const cellAction = row.insertCell(0);
        const cellMessage = row.insertCell(1);
        cellAction.textContent = item.slotAction;
        cellMessage.textContent = item.scrMessage;
      });

      logContainer.style.display = 'block';
      logContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    /******************************************
     DOWNLOAD CSV
    ******************************************/
    function downloadCSV() {
      if (logData.length === 0) {
        alert('No log data available to download.');
        return;
      }

      const csvRows = [
        ['Slot Action', 'SCR Message'],
        ...logData.map((item) => [
          item.slotAction,
          item.scrMessage.replace(/\n/g, ' ')
        ])
      ];

      const csvContent = csvRows
        .map((row) => row.map((field) => `"${field.replace(/"/g, '""')}"`).join(','))
        .join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', 'scr_log.csv');
      link.style.display = 'none';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
